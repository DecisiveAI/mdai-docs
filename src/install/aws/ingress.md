# Managing Ingress in AWS for the OTel Collector

<!-- toc -->

## DNS

To expose the OpenTelemetry Collector within the MDAI Engine to the public, we've simplified the provisioning of two Load Balancers

1. AWS Application Load Balancer `mdai-grpc-endpoint`
2. AWS Network Load Balancer `mdai-non-grpc-endpoint`

These LoadBalancers receive **gRPC** and **non-gRPC** (HTTP, TCP, UDP) data respectively.

The Load Balancers can be referred to by the DNS names, assigned by AWS. [![DNS LB Names](../media/load-balancers.png)](../media/load-balancers.png)

> For secure connectivity, it’s highly recommended (and for SSL endpoints - mandated) to create CNAME DNS records in your domain, pointing to the Load Balancer DNS names generated by AWS.

### gRPC

In order to provide routing for multiple gRPC receivers of the same type, each receiver should have its own hostname in your public domain. Additional configuration steps are required to provide a mapping between the receiver name and its proposed hostname. A single gRPC Load Balancer will be able to manage ingest from multiple gRPC sources and our solution only provides a single gRPC Load Balancer by default.

#### Example

**LB DNS name:**
`mdai-grpc-endpoint.us-east-1.elb.amazonaws.com`

**Otel collector config excerpt**
_This example has 2 gRPC receivers._

```yaml
service:
  pipelines:
    traces:
      receivers: [jaeger, otlp]
      processors: [memory_limiter, batch]
      exporters: [debug]
```

**Required CNAME records in domain `your-domain.io`:**
| CNAME | AWS DNS NAME | Access URL |
| ----------- | --------------- |------------ |
| `jaeger.grpc.endpoint` | `mdai-grpc-endpoint.us-east-1.elb.amazonaws.com` | `jaeger.grpc.endpoint.your-domain.io` |
| `otlp.grpc.endpoint` | `mdai-grpc-endpoint.us-east-1.elb.amazonaws.com` | `otlp.grpc.endpoint.your-domain.io` |

**Manual updates for OpenTelemetry collector configuration**
You would then need to update your OTel configure to reflect the changes to receive ingest via the access url.

Navigate to your `values/params-values-otel.yaml` file:

```yaml
collectorEndpoints:
  otlp: otlp.grpc.endpoint.collector.your-domain.io
  jaeger: jaeger.grpc.endpoint.collector.your-domain.io
```

### non-gRPC

#### Example

**LB DNS name**
`mdai-non-grpc-endpoint.us-east-1.elb.amazonaws.com`

**Required CNAME records in domain `your-domain.io`:**

| CNAME      | AWS DNS NAME                                         | Access URL                |
| ---------- | ---------------------------------------------------- | ------------------------- |
| `endpoint` | `mdai-non-grpc-endpoint.us-east-1.elb.amazonaws.com` | `endpoint.your-domain.io` |

## SSL

SSL Certificates should be generated and issued for all chosen host names.

**Steps for Issuing or Importing a Certificate**

- Choose to [Import](https://docs.aws.amazon.com/acm/latest/userguide/import-certificate-api-cli.html) or [Issue](https://docs.aws.amazon.com/acm/latest/userguide/gs.html) a Certificate
- Once you have access to your cert in AWS ACM, it will be accessible via Amazon Resource Name (ARN). These ARNs need to be provided as configuration parameter during the configuration phase, so make note of these ARNs. [![ACM ARN](../media/acm-certificates.png)](../media/acm-certificates.png)

### gRPC

- SSL is **MANDATORY** for gRPC the endpoint.

- From the example above, the gRPC host names that would need certs are

  - `jaeger.grpc.endpoint.your-domain.io`
  - `otlp.grpc.endpoint.your-domain.io`

- After identifying the cert ARN, you are required to update the `values/params-values-otel.yaml` file:

```yaml
spec:
  ingress:
    annotations:
      alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:us-east-1:1234567890:certificate/th15-15-@n-@ut0g3n3r@ted-numb3r
```

### non-gRPC

- SSL is _not mandatory_, but is highly recommend for non-gRPC ingress

- From the example above, the gRPC host names that would need certs are

  - `endpoint.your-domain.io`

- After identifying the cert ARN, you are required to update the `values/params-values-otel.yaml` file:

```yaml
metadata:
  name: test-collector
  namespace: default
  annotations:
	service.beta.kubernetes.io/aws-load-balancer-ssl-cert: arn:aws:acm:us-east-1:1234567890:certificate/th15-15-@n-@ut0g3n3r@ted-numb3r
```

## Engine UI

### DNS

To expose UI to the public, AWS Application Load Balancer `mydecisive-engine-ui` will be provisioned.
For secure connectivity, it’s highly recommended (and for SSL endpoints - mandated) to create CNAME DNS records in your domain, pointing to the Load Balancer DNS names generated by AWS.

> This Load balancer can be referred to by the DNS name, provided by AWS, however it’s **_highly recommended_** (and to enable SSL endpoint - mandated) to create a CNAME DNS record in your domain, pointing to the Load Balancer DNS name.

#### Example

**LB DNS name**: `mydecisive-engine-ui-12345678910.us-east-1.elb.amazonaws.com`

**Required CNAME records in domain `your-domain.io`:**
| CNAME | AWS DNS NAME | Access URL |
| ----------- | --------------- |------------ |
| `mydecisive-console` | `mydecisive-engine-ui-12345678910.us-east-1.elb.amazonaws.com` | `mydecisive-console.your-domain.io` |

### SSL

SSL can be enabled for the Engine UI endpoint. In order to do that, SSL certificate should be issued for the chosen hostname (i.e. mydecisive.domain.dom from the example above), imported to the AWS ACM, and accessible via Amazon Resource Name (ARN).
This ARN needs to be provided as a configuration parameter during the configuration phase.
File values/aws.env:

MDAI_UI_ACM_ARN=arn:aws:acm:us-east-1:12345678900:certificate/eaa7da72-1c8d-4277-8131-ab9dfdc35f37
